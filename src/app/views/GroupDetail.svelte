<script>
  import {onMount} from "svelte"
  import {whereEq, without} from "ramda"
  import {randomId, ucFirst} from "hurdak"
  import {noteKinds} from "src/util/nostr"
  import {getKey} from "src/util/router"
  import {themeBackgroundGradient} from "src/partials/state"
  import FlexColumn from "src/partials/FlexColumn.svelte"
  import Tabs from "src/partials/Tabs.svelte"
  import Anchor from "src/partials/Anchor.svelte"
  import Calendar from "src/app/shared/Calendar.svelte"
  import GroupCircle from "src/app/shared/GroupCircle.svelte"
  import GroupActions from "src/app/shared/GroupActions.svelte"
  import GroupAbout from "src/app/shared/GroupAbout.svelte"
  import GroupRequest from "src/app/shared/GroupRequest.svelte"
  import GroupMember from "src/app/shared/GroupMember.svelte"
  import GroupMarket from "src/app/shared/GroupMarket.svelte"
  import NoteCreateInline from "src/app/shared/NoteCreateInline.svelte"
  import Feed from "src/app/shared/Feed.svelte"
  import {
    env,
    canSign,
    GroupAccess,
    displayGroup,
    session,
    loadPubkeys,
    publishGroupEntryRequest,
    groupRequests,
    deriveGroup,
    deriveAdminKeyForGroup,
    deriveSharedKeyForGroup,
    deriveIsGroupMember,
    deriveGroupStatus,
    loadGroups,
    loadGroupMessages,
  } from "src/engine"
  import {router} from "src/app/router"

  export let address
  export let relays = null
  export let activeTab = "notes"
  export let claim = ""

  const group = deriveGroup(address)
  const status = deriveGroupStatus(address)
  const isGroupMember = deriveIsGroupMember(address)
  const sharedKey = deriveSharedKeyForGroup(address)
  const adminKey = deriveAdminKeyForGroup(address)
  const requests = groupRequests.derived(requests =>
    requests.filter(whereEq({group: address, resolved: false})),
  )

  const setActiveTab = tab =>
    router
      .at("groups")
      .of(address)
      .at(tab)
      .push({key: getKey(router.current.get())})

  const loadGroupData = () => {
    loadGroups([address], relays)
    loadGroupMessages([address], relays)
    loadPubkeys($group.members || [])
  }

  onMount(loadGroupData)

  let tabs
  let key = randomId()

  $: {
    if ($isGroupMember) {
      loadGroupData()
      key = randomId()
    }
  }

  $: {
    tabs = ["notes"]

    if (!$env.FORCE_GROUP) {
      tabs.push("calendar")
      tabs.push("market")
    }

    if ($sharedKey) {
      tabs.push("members")
    } else if (activeTab === "members") {
      activeTab = "notes"
    }

    if ($adminKey && address.startsWith("35834")) {
      tabs.push("admin")
    } else if (activeTab === "admin") {
      activeTab = "notes"
    }
  }

  $: ({rgb, rgba} = $themeBackgroundGradient)

  document.title = $group?.name || "Group Detail"
</script>

<div
  class="absolute left-0 top-0 h-64 w-full"
  style={`z-index: -1;
         background-size: cover;
         background-image: linear-gradient(to bottom, ${rgba}, ${rgb}), url('${$group?.meta?.banner}')`} />

<div class="flex gap-4 text-neutral-100">
  <GroupCircle {address} class="mt-1 h-10 w-10 sm:h-32 sm:w-32" />
  <div class="flex min-w-0 flex-grow flex-col gap-4">
    <div class="flex items-center justify-between gap-4">
      <Anchor on:click={() => setActiveTab("notes")} class="text-2xl"
        >{displayGroup($group)}</Anchor>
      <GroupActions {address} {claim} />
    </div>
    <GroupAbout {address} />
  </div>
</div>

{#if tabs.length > 1}
  <Tabs {tabs} {activeTab} {setActiveTab}>
    <div slot="tab" let:tab class="flex gap-2">
      <div>{ucFirst(tab)}</div>
      {#if tab === "admin" && $requests.length > 0}
        <div class="h-6 rounded-full bg-neutral-700 px-2">
          {$requests.length}
        </div>
      {/if}
    </div>
  </Tabs>
{/if}

{#if address.startsWith("35834") && $status.access !== GroupAccess.Granted}
  <p class="m-auto max-w-sm py-12 text-center">
    {#if $status.access === GroupAccess.Requested}
      Your access request is awaiting approval.
    {:else}
      You don't have access to this group.
    {/if}
    {#if $session && !$status.access}
      Click <Anchor underline on:click={() => publishGroupEntryRequest(address)}>here</Anchor> to request
      entry.
    {/if}
  </p>
{:else if activeTab === "notes"}
  {#if $canSign}
    <NoteCreateInline group={address} />
  {/if}
  {#key key}
    <Feed
      eager
      shouldListen
      hideControls
      filter={{kinds: without([30402], noteKinds), "#a": [address]}} />
  {/key}
{:else if activeTab === "calendar"}
  <Calendar group={address} filters={[{kinds: [31923], "#a": [address]}]} />
{:else if activeTab === "market"}
  <GroupMarket group={address} />
{:else if activeTab === "members"}
  <FlexColumn>
    {#each $group.members || [] as pubkey (pubkey)}
      <GroupMember {address} {pubkey} />
    {:else}
      <p class="text-center py-12">No members found.</p>
    {/each}
  </FlexColumn>
{:else if activeTab === "admin"}
  {#each $requests as request (request.id)}
    <GroupRequest {address} {request} />
  {:else}
    <p class="text-center py-12">No action items found.</p>
  {/each}
{/if}
